<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
    />
    <title>Manage Profiles</title>
    <link rel="stylesheet" href="../../shared/styles/base.css" />
    <style>
      :root {
        color-scheme: dark;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          sans-serif;
      }
      body {
        margin: 0;
        padding: 16px;
        background: #0b0b0d;
        color: #f5f5f5;
      }
      h1 {
        font-size: 18px;
        margin: 0 0 12px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .title-icon {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }
      .profile-list {
        margin-bottom: 16px;
      }
      .profile-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: #141418;
        border: 1px solid #222;
        border-radius: 4px;
        margin-bottom: 8px;
      }
      .profile-item.active {
        border-color: #e50914;
        background: #1a0000;
      }
      .profile-info {
        flex: 1;
      }
      .profile-name {
        font-weight: 600;
        margin-bottom: 2px;
      }
      .profile-url {
        font-size: 12px;
        color: #888;
        word-break: break-all;
      }
      button {
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        background: #e50914;
        color: #fff;
        cursor: pointer;
        font-weight: 500;
        font-size: 13px;
      }
      button.secondary {
        background: #333;
      }
      button.danger {
        background: #d32f2f;
      }
      button:hover {
        opacity: 0.9;
      }
      .add-profile {
        padding: 12px;
        background: #141418;
        border: 1px solid #222;
        border-radius: 4px;
        margin-bottom: 16px;
      }
      input[type='text'] {
        width: 100%;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #333;
        background: #0b0b0d;
        color: #f5f5f5;
        box-sizing: border-box;
        margin-bottom: 8px;
      }
      .hint {
        font-size: 11px;
        color: #aaa;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <h1>
      <svg class="title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <circle cx="12" cy="8" r="4" />
        <path d="M4 20c0-3.31 3.58-6 8-6s8 2.69 8 6" />
      </svg>
      <span>Manage Profiles</span>
    </h1>

    <div class="add-profile">
      <input type="text" id="profileName" placeholder="Profile Name" />
      <input
        type="text"
        id="profileUrl"
        placeholder="Netflix URL (optional)"
        value="https://www.netflix.com/"
      />
      <button onclick="addProfile()">Add Profile</button>
      <div class="hint">Leave URL as default or set specific Netflix profile URL</div>
    </div>

    <div class="profile-list" id="profileList"></div>

    <button class="secondary" onclick="window.close()">Close</button>

    <script>
      const { profilesAPI } = window;

      async function loadProfiles() {
        try {
          const { profiles, current } = await profilesAPI.getProfiles();
          const container = document.getElementById('profileList');

          container.innerHTML = Object.entries(profiles)
            .map(
              ([id, profile]) => `
          <div class="profile-item ${id === current ? 'active' : ''}">
            <div class="profile-info">
              <div class="profile-name">${profile.name} ${id === current ? 'âœ“' : ''}</div>
              <div class="profile-url">${profile.url}</div>
            </div>
            ${id !== 'default' ? `<button class="danger" onclick="deleteProfile('${id}')">Delete</button>` : ''}
            <button onclick="switchProfile('${id}')">${id === current ? 'Current' : 'Switch'}</button>
          </div>
        `
            )
            .join('');
        } catch (e) {
          alert('Failed to load profiles: ' + e.message);
        }
      }

      async function addProfile() {
        const name = document.getElementById('profileName').value.trim();
        const url = document.getElementById('profileUrl').value.trim();

        if (!name || name.length > 50) {
          alert('Profile name must be 1-50 characters');
          return;
        }

        try {
          const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
          await profilesAPI.addProfile({ id, name, url });

          document.getElementById('profileName').value = '';
          document.getElementById('profileUrl').value = 'https://www.netflix.com/';
          await loadProfiles();
        } catch (e) {
          alert('Failed to add profile: ' + e.message);
        }
      }

      async function deleteProfile(id) {
        if (!confirm('Delete this profile?')) return;

        try {
          await profilesAPI.deleteProfile(id);
          await loadProfiles();
        } catch (e) {
          alert('Failed to delete profile: ' + e.message);
        }
      }

      async function switchProfile(id) {
        try {
          await profilesAPI.switchProfile(id);
          await loadProfiles();
        } catch (e) {
          alert('Failed to switch profile: ' + e.message);
        }
      }

      window.addEventListener('DOMContentLoaded', loadProfiles);
    </script>
  </body>
</html>
